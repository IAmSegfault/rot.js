!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";var t,e;t=void 0,e=function(t){var e=2.3283064365386963e-10,i=function(){function t(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}var i=t.prototype;return i.getSeed=function(){return this._seed},i.setSeed=function(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*e,t=69069*t+1>>>0,this._s1=t*e,t=69069*t+1>>>0,this._s2=t*e,this._c=1,this},i.getUniform=function(){var t=2091639*this._s0+this._c*e;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2},i.getUniformInt=function(t,e){var i=Math.max(t,e),r=Math.min(t,e);return Math.floor(this.getUniform()*(i-r+1))+r},i.getNormal=function(t,e){var i,r,o;void 0===t&&(t=0),void 0===e&&(e=1);do{o=(i=2*this.getUniform()-1)*i+(r=2*this.getUniform()-1)*r}while(o>1||0==o);return t+i*Math.sqrt(-2*Math.log(o)/o)*e},i.getPercentage=function(){return 1+Math.floor(100*this.getUniform())},i.getItem=function(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null},i.shuffle=function(t){for(var e=[],i=t.slice();i.length;){var r=i.indexOf(this.getItem(i));e.push(i.splice(r,1)[0])}return e},i.getWeightedValue=function(t){var e=0;for(var i in t)e+=t[i];var r,o=this.getUniform()*e,n=0;for(r in t)if(o<(n+=t[r]))return r;return r},i.getState=function(){return[this._s0,this._s1,this._s2,this._c]},i.setState=function(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this},i.clone=function(){var e=new t;return e.setState(this.getState())},t}(),r=(new i).setSeed(Date.now()),o=function(){function t(){}var e=t.prototype;return e.getContainer=function(){return null},e.setOptions=function(t){this._options=t},t}();function n(t,e){return n=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},n(t,e)}var s=function(t){var e,i;function r(){var e;return(e=t.call(this)||this)._ctx=document.createElement("canvas").getContext("2d"),e}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,n(e,i);var o=r.prototype;return o.schedule=function(t){requestAnimationFrame(t)},o.getContainer=function(){return this._ctx.canvas},o.setOptions=function(e){t.prototype.setOptions.call(this,e);var i=(e.fontStyle?e.fontStyle+" ":"")+" "+e.fontSize+"px "+e.fontFamily;this._ctx.font=i,this._updateSize(),this._ctx.font=i,this._ctx.textAlign="center",this._ctx.textBaseline="middle"},o.clear=function(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)},o.eventToPosition=function(t,e){var i=this._ctx.canvas,r=i.getBoundingClientRect();return t-=r.left,e-=r.top,t*=i.width/r.width,e*=i.height/r.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)},r}(o);function a(t,e){return(t%e+e)%e}function h(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=1),t<e?e:t>i?i:t}function c(t){return t.charAt(0).toUpperCase()+t.substring(1)}function l(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];var o=l.map,n=function(e,r,n,s){if("%"==t.charAt(s-1))return e.substring(1);if(!i.length)return e;var a=i[0],h=(r||n).split(","),l=h.shift()||"",u=o[l.toLowerCase()];if(!u)return e;var _=(a=i.shift())[u].apply(a,h),f=l.charAt(0);return f!=f.toLowerCase()&&(_=c(_)),_};return t.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,n)}l.map={s:"toString"};var u=Object.freeze({__proto__:null,mod:a,clamp:h,capitalize:c,format:l});function _(t,e){return _=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},_(t,e)}var f=function(t){var e,i;function r(){var e;return(e=t.call(this)||this)._spacingX=0,e._spacingY=0,e._hexSize=0,e}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,_(e,i);var o=r.prototype;return o.draw=function(t,e){var i=t[0],r=t[1],o=t[2],n=t[3],s=t[4],a=[(i+1)*this._spacingX,r*this._spacingY+this._hexSize];if(this._options.transpose&&a.reverse(),e&&(this._ctx.fillStyle=s,this._fill(a[0],a[1])),o){this._ctx.fillStyle=n;for(var h=[].concat(o),c=0;c<h.length;c++)this._ctx.fillText(h[c],a[0],Math.ceil(a[1]))}},o.computeSize=function(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]},o.computeFontSize=function(t,e){this._options.transpose&&(t+=e,t-=e=t-e);var i=2*t/((this._options.width+1)*Math.sqrt(3))-1,r=e/(2+1.5*(this._options.height-1)),o=Math.min(i,r),n=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;var s=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=n;var a=s/100,h=2*(o=Math.floor(o)+1)/(this._options.spacing*(1+a/Math.sqrt(3)));return Math.ceil(h)-1},o._normalizedEventToPosition=function(t,e){var i;this._options.transpose?(t+=e,t-=e=t-e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;var r=i/this._options.height;return a(e=Math.floor(e/r),2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]},o._fill=function(t,e){var i=this._hexSize,r=this._options.border,o=this._ctx;o.beginPath(),this._options.transpose?(o.moveTo(t-i+r,e),o.lineTo(t-i/2+r,e+this._spacingX-r),o.lineTo(t+i/2-r,e+this._spacingX-r),o.lineTo(t+i-r,e),o.lineTo(t+i/2-r,e-this._spacingX+r),o.lineTo(t-i/2+r,e-this._spacingX+r),o.lineTo(t-i+r,e)):(o.moveTo(t,e-i+r),o.lineTo(t+this._spacingX-r,e-i/2+r),o.lineTo(t+this._spacingX-r,e+i/2-r),o.lineTo(t,e+i-r),o.lineTo(t-this._spacingX+r,e+i/2-r),o.lineTo(t-this._spacingX+r,e-i/2+r),o.lineTo(t,e-i+r)),o.fill()},o._updateSize=function(){var t,e,i=this._options,r=Math.ceil(this._ctx.measureText("W").width);this._hexSize=Math.floor(i.spacing*(i.fontSize+r/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,i.transpose?(t="height",e="width"):(t="width",e="height"),this._ctx.canvas[t]=Math.ceil((i.width+1)*this._spacingX),this._ctx.canvas[e]=Math.ceil((i.height-1)*this._spacingY+2*this._hexSize)},r}(s);function p(t,e){return p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},p(t,e)}var d=function(t){var e,i;function r(){var e;return(e=t.call(this)||this)._spacingX=0,e._spacingY=0,e._canvasCache={},e}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,p(e,i);var o=r.prototype;return o.setOptions=function(e){t.prototype.setOptions.call(this,e),this._canvasCache={}},o.draw=function(t,e){r.cache?this._drawWithCache(t):this._drawNoCache(t,e)},o._drawWithCache=function(t){var e,i=t[0],r=t[1],o=t[2],n=t[3],s=t[4],a=""+o+n+s;if(a in this._canvasCache)e=this._canvasCache[a];else{var h=this._options.border,c=(e=document.createElement("canvas")).getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,c.fillStyle=s,c.fillRect(h,h,e.width-h,e.height-h),o){c.fillStyle=n,c.font=this._ctx.font,c.textAlign="center",c.textBaseline="middle";for(var l=[].concat(o),u=0;u<l.length;u++)c.fillText(l[u],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=e}this._ctx.drawImage(e,i*this._spacingX,r*this._spacingY)},o._drawNoCache=function(t,e){var i=t[0],r=t[1],o=t[2],n=t[3],s=t[4];if(e){var a=this._options.border;this._ctx.fillStyle=s,this._ctx.fillRect(i*this._spacingX+a,r*this._spacingY+a,this._spacingX-a,this._spacingY-a)}if(o){this._ctx.fillStyle=n;for(var h=[].concat(o),c=0;c<h.length;c++)this._ctx.fillText(h[c],(i+.5)*this._spacingX,Math.ceil((r+.5)*this._spacingY))}},o.computeSize=function(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]},o.computeFontSize=function(t,e){var i=Math.floor(t/this._options.width),r=Math.floor(e/this._options.height),o=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;var n=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=o;var s=n/100*r/i;return s>1&&(r=Math.floor(r/s)),Math.floor(r/this._options.spacing)},o._normalizedEventToPosition=function(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]},o._updateSize=function(){var t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY},r}(s);function g(t,e){return g=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},g(t,e)}d.cache=!1;var v=function(t){var e,i;function r(){var e;return(e=t.call(this)||this)._colorCanvas=document.createElement("canvas"),e}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,g(e,i);var o=r.prototype;return o.draw=function(t,e){var i=t[0],r=t[1],o=t[2],n=t[3],s=t[4],a=this._options.tileWidth,h=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*a,r*h,a,h):(this._ctx.fillStyle=s,this._ctx.fillRect(i*a,r*h,a,h))),o)for(var c=[].concat(o),l=[].concat(n),u=[].concat(s),_=0;_<c.length;_++){var f=this._options.tileMap[c[_]];if(!f)throw new Error('Char "'+c[_]+'" not found in tileMap');if(this._options.tileColorize){var p=this._colorCanvas,d=p.getContext("2d");d.globalCompositeOperation="source-over",d.clearRect(0,0,a,h);var g=l[_],v=u[_];d.drawImage(this._options.tileSet,f[0],f[1],a,h,0,0,a,h),"transparent"!=g&&(d.fillStyle=g,d.globalCompositeOperation="source-atop",d.fillRect(0,0,a,h)),"transparent"!=v&&(d.fillStyle=v,d.globalCompositeOperation="destination-over",d.fillRect(0,0,a,h)),this._ctx.drawImage(p,i*a,r*h,a,h)}else this._ctx.drawImage(this._options.tileSet,f[0],f[1],a,h,i*a,r*h,a,h)}},o.computeSize=function(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]},o.computeFontSize=function(){throw new Error("Tile backend does not understand font size")},o._normalizedEventToPosition=function(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]},o._updateSize=function(){var t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight},r}(s);function m(t){var e,i;if(t in S)e=S[t];else{if("#"==t.charAt(0)){var r=(t.match(/[0-9a-f]/gi)||[]).map((function(t){return parseInt(t,16)}));if(3==r.length)e=r.map((function(t){return 17*t}));else{for(var o=0;o<3;o++)r[o+1]+=16*r[o],r.splice(o,1);e=r}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map((function(t){return parseInt(t)})):[0,0,0];S[t]=e}return e.slice()}function b(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];for(var o=0;o<3;o++)for(var n=0;n<i.length;n++)t[o]+=i[n][o];return t}function y(t,e,i){void 0===i&&(i=.5);for(var r=t.slice(),o=0;o<3;o++)r[o]=Math.round(r[o]+i*(e[o]-t[o]));return r}var w=y;function O(t,e,i){void 0===i&&(i=.5);for(var r=E(t),o=E(e),n=0;n<3;n++)r[n]+=i*(o[n]-r[n]);return T(r)}var P=O;function E(t){var e,i=t[0]/255,r=t[1]/255,o=t[2]/255,n=Math.max(i,r,o),s=Math.min(i,r,o),a=0,h=(n+s)/2;if(n==s)e=0;else{var c=n-s;switch(e=h>.5?c/(2-n-s):c/(n+s),n){case i:a=(r-o)/c+(r<o?6:0);break;case r:a=(o-i)/c+2;break;case o:a=(i-r)/c+4}a/=6}return[a,e,h]}function x(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}function T(t){var e=t[2];if(0==t[1])return[e=Math.round(255*e),e,e];var i=t[1],r=e<.5?e*(1+i):e+i-e*i,o=2*e-r,n=x(o,r,t[0]+1/3),s=x(o,r,t[0]),a=x(o,r,t[0]-1/3);return[Math.round(255*n),Math.round(255*s),Math.round(255*a)]}var S={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]},C=Object.freeze({__proto__:null,fromString:m,add:function(t){for(var e=t.slice(),i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];for(var n=0;n<3;n++)for(var s=0;s<r.length;s++)e[n]+=r[s][n];return e},add_:b,multiply:function(t){for(var e=t.slice(),i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];for(var n=0;n<3;n++){for(var s=0;s<r.length;s++)e[n]*=r[s][n]/255;e[n]=Math.round(e[n])}return e},multiply_:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];for(var o=0;o<3;o++){for(var n=0;n<i.length;n++)t[o]*=i[n][o]/255;t[o]=Math.round(t[o])}return t},interpolate:y,lerp:w,interpolateHSL:O,lerpHSL:P,randomize:function(t,e){e instanceof Array||(e=Math.round(r.getNormal(0,e)));for(var i=t.slice(),o=0;o<3;o++)i[o]+=e instanceof Array?Math.round(r.getNormal(0,e[o])):e;return i},rgb2hsl:E,hsl2rgb:T,toRGB:function(t){return"rgb("+t.map((function(t){return h(t,0,255)})).join(",")+")"},toHex:function(t){return"#"+t.map((function(t){return h(t,0,255).toString(16).padStart(2,"0")})).join("")}});function R(t,e){return R=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},R(t,e)}var M=function(t){var e,i;function r(){var e;(e=t.call(this)||this)._uniforms={},e._glVersion="webgl2";try{e._gl=e._initWebGL()}catch(t){"string"==typeof t?alert(t):t instanceof Error&&alert(t.message)}return e}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,R(e,i),r.isSupported=function(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})};var o=r.prototype;return o.schedule=function(t){requestAnimationFrame(t)},o.getContainer=function(){return this._gl.canvas},o.setOptions=function(e){var i=this;t.prototype.setOptions.call(this,e),this._updateSize();var r=this._options.tileSet;r&&"complete"in r&&!r.complete?r.addEventListener("load",(function(){return i._updateTexture(r)})):this._updateTexture(r)},o.draw=function(t,e){var i=this._gl,r=this._options,o=t[0],n=t[1],s=t[2],a=t[3],h=t[4],c=i.canvas.height-(n+1)*r.tileHeight;if(i.scissor(o*r.tileWidth,c,r.tileWidth,r.tileHeight),e&&(r.tileColorize?i.clearColor(0,0,0,0):i.clearColor.apply(i,U(h)),i.clear(i.COLOR_BUFFER_BIT)),s){var l=[].concat(s),u=[].concat(h),_=[].concat(a);i.uniform2fv(this._uniforms.targetPosRel,[o,n]);for(var f=0;f<l.length;f++){var p=this._options.tileMap[l[f]];if(!p)throw new Error('Char "'+l[f]+'" not found in tileMap');i.uniform1f(this._uniforms.colorize,r.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,p),r.tileColorize&&(i.uniform4fv(this._uniforms.tint,U(_[f])),i.uniform4fv(this._uniforms.bg,U(u[f]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}},o.clear=function(){var t=this._gl;t.clearColor.apply(t,U(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)},o.computeSize=function(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]},o.computeFontSize=function(){throw new Error("Tile backend does not understand font size")},o.eventToPosition=function(t,e){var i=this._gl.canvas,r=i.getBoundingClientRect();return t-=r.left,e-=r.top,t*=i.width/r.width,e*=i.height/r.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)},o._initWebGL=function(){var t=this,e=document.createElement("canvas").getContext(this._glVersion,{preserveDrawingBuffer:!0});window.gl=e;var i=function(t,e,i){var r=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(r)||"");var o=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(o,i),t.compileShader(o),!t.getShaderParameter(o,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(o)||"");var n=t.createProgram();if(t.attachShader(n,r),t.attachShader(n,o),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(n)||"");return n}(e,A,K);return e.useProgram(i),function(t){var e=new Float32Array([0,0,1,0,0,1,1,1]),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0)}(e),V.forEach((function(r){return t._uniforms[r]=e.getUniformLocation(i,r)})),this._program=i,e.enable(e.BLEND),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.enable(e.SCISSOR_TEST),e},o._normalizedEventToPosition=function(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]},o._updateSize=function(){var t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)},o._updateTexture=function(t){var e,i,r;e=this._gl,i=t,r=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i)},r}(o),V=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],A="\n#version 300 es\n\nin vec2 tilePosRel;\nout vec2 tilesetPosPx;\n\nuniform vec2 tilesetPosAbs;\nuniform vec2 tileSize;\nuniform vec2 targetSize;\nuniform vec2 targetPosRel;\n\nvoid main() {\n\tvec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;\n\tvec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;\n\ttargetPosNdc.y *= -1.0;\n\n\tgl_Position = vec4(targetPosNdc, 0.0, 1.0);\n\ttilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;\n}".trim(),K="\n#version 300 es\nprecision highp float;\n\nin vec2 tilesetPosPx;\nout vec4 fragColor;\nuniform sampler2D image;\nuniform bool colorize;\nuniform vec4 bg;\nuniform vec4 tint;\n\nvoid main() {\n\tfragColor = vec4(0, 0, 0, 1);\n\n\tvec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);\n\n\tif (colorize) {\n\t\ttexel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;\n\t\tfragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;\n\t\tfragColor.a = texel.a + (1.0-texel.a)*bg.a;\n\t} else {\n\t\tfragColor = texel;\n\t}\n}".trim(),k={};function U(t){if(!(t in k)){var e;if("transparent"==t)e=[0,0,0,0];else if(t.indexOf("rgba")>-1){e=(t.match(/[\d.]+/g)||[]).map(Number);for(var i=0;i<3;i++)e[i]=e[i]/255}else(e=m(t).map((function(t){return t/255}))).push(1);k[t]=e}return k[t]}function I(t,e){return I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},I(t,e)}var L=function(t){var e,i;function r(){var e;(e=t.call(this)||this)._uniforms={},e._glVersion="webgl";try{e._gl=e._initWebGL()}catch(t){"string"==typeof t?alert(t):t instanceof Error&&alert(t.message)}return e}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,I(e,i),r.isSupported=function(){return!!document.createElement("canvas").getContext("webgl",{preserveDrawingBuffer:!0})};var o=r.prototype;return o.schedule=function(t){requestAnimationFrame(t)},o.getContainer=function(){return this._gl.canvas},o.setOptions=function(e){var i=this;t.prototype.setOptions.call(this,e),this._updateSize();var r=this._options.tileSet;r&&"complete"in r&&!r.complete?r.addEventListener("load",(function(){return i._updateTexture(r)})):this._updateTexture(r)},o.draw=function(t,e){var i=this._gl,r=this._options,o=t[0],n=t[1],s=t[2],a=t[3],h=t[4],c=i.canvas.height-(n+1)*r.tileHeight;if(i.scissor(o*r.tileWidth,c,r.tileWidth,r.tileHeight),e&&(r.tileColorize?i.clearColor(0,0,0,0):i.clearColor.apply(i,F(h)),i.clear(i.COLOR_BUFFER_BIT)),s){var l=[].concat(s),u=[].concat(h),_=[].concat(a);i.uniform2fv(this._uniforms.targetPosRel,[o,n]);for(var f=0;f<l.length;f++){var p=this._options.tileMap[l[f]];if(!p)throw new Error('Char "'+l[f]+'" not found in tileMap');i.uniform1f(this._uniforms.colorize,r.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,p),r.tileColorize&&(i.uniform4fv(this._uniforms.tint,F(_[f])),i.uniform4fv(this._uniforms.bg,F(u[f]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}},o.clear=function(){var t=this._gl;t.clearColor.apply(t,F(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)},o.computeSize=function(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]},o.computeFontSize=function(){throw new Error("Tile backend does not understand font size")},o.eventToPosition=function(t,e){var i=this._gl.canvas,r=i.getBoundingClientRect();return t-=r.left,e-=r.top,t*=i.width/r.width,e*=i.height/r.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)},o._initWebGL=function(){var t=this,e=document.createElement("canvas").getContext(this._glVersion,{preserveDrawingBuffer:!0});window.gl=e;var i=function(t,e,i){var r=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(r)||"");var o=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(o,i),t.compileShader(o),!t.getShaderParameter(o,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(o)||"");var n=t.createProgram();if(t.attachShader(n,r),t.attachShader(n,o),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(n)||"");return n}(e,N,j);return e.useProgram(i),function(t){var e=new Float32Array([0,0,1,0,0,1,1,1]),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0)}(e),D.forEach((function(r){return t._uniforms[r]=e.getUniformLocation(i,r)})),this._program=i,e.enable(e.BLEND),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.enable(e.SCISSOR_TEST),e},o._normalizedEventToPosition=function(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]},o._updateSize=function(){var t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)},o._updateTexture=function(t){var e,i,r,o=t.width,n=t.height;this._gl.uniform2fv(this._uniforms.textureSize,[o,n]),e=this._gl,i=t,r=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i)},r}(o),D=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint","textureSize"],N="\n#version 100\n\nattribute vec2 tilePosRel;\nattribute vec2 tilesetPosPx;\n\nuniform vec2 tilesetPosAbs;\nuniform vec2 tileSize;\nuniform vec2 targetSize;\nuniform vec2 targetPosRel;\nvarying vec2 vTilePosRel;\nvarying vec2 vTilesetPosPx;\n\nvoid main() {\n\n\tvTilePosRel = tilePosRel;\n\tvTilesetPosPx = tilesetPosPx;\n\tvec2 targetPosPx = (targetPosRel + vTilePosRel) * tileSize;\n\tvec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;\n\ttargetPosNdc.y *= -1.0;\n\n\tgl_Position = vec4(targetPosNdc, 0.0, 1.0);\n\tvTilesetPosPx = tilesetPosAbs + vTilePosRel * tileSize;\n}".trim(),j="\n#version 100\nprecision highp float;\nvarying vec2 vTilePosRel;\nvarying vec2 vTilesetPosPx;\nuniform sampler2D image;\nuniform bool colorize;\nuniform vec4 bg;\nuniform vec4 tint;\nuniform vec2 textureSize;\n\nvec4 texelFetch(sampler2D tex, vec2 size, vec2 coord) {\n    return texture2D(tex, vec2(float(coord.x) / float(size.x), float(coord.y) / float(size.y)));\n}\n\nvoid main() {\n\n\tvec4 vFragColor = vec4(0, 0, 0, 1);\n\tvec4 texel = texelFetch(image, textureSize, vTilesetPosPx);\n\n\tif (colorize) {\n\t\ttexel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;\n\t\tvFragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;\n\t\tvFragColor.a = texel.a + (1.0-texel.a)*bg.a;\n\t} else {\n\t\tvFragColor = texel;\n\t}\n\tgl_FragColor = vFragColor;\n}".trim(),z={};function F(t){if(!(t in z)){var e;if("transparent"==t)e=[0,0,0,0];else if(t.indexOf("rgba")>-1){e=(t.match(/[\d.]+/g)||[]).map(Number);for(var i=0;i<3;i++)e[i]=e[i]/255}else(e=m(t).map((function(t){return t/255}))).push(1);z[t]=e}return z[t]}function W(t,e){return W=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},W(t,e)}function X(t){var e=6/256,i=m(t);return 36*Math.floor(i[0]*e)+6*Math.floor(i[1]*e)+1*Math.floor(i[2]*e)+16}var H=function(t){var e,i;function r(){var e;return(e=t.call(this)||this)._offset=[0,0],e._cursor=[-1,-1],e._lastColor="",e}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,W(e,i);var o=r.prototype;return o.schedule=function(t){setTimeout(t,1e3/60)},o.setOptions=function(e){t.prototype.setOptions.call(this,e);var i=[e.width,e.height],r=this.computeSize();this._offset=r.map((function(t,e){return Math.floor((t-i[e])/2)}))},o.clear=function(){process.stdout.write("[0;48;5;"+X(this._options.bg)+"m[2J")},o.draw=function(t,e){var i=t[0],r=t[1],o=t[2],n=t[3],s=t[4],a=this._offset[0]+i,h=this._offset[1]+r,c=this.computeSize();if(!(a<0||a>=c[0])&&!(h<0||h>=c[1])&&(a===this._cursor[0]&&h===this._cursor[1]||(process.stdout.write(function(t,e){return"["+(e+1)+";"+(t+1)+"H"}(a,h)),this._cursor[0]=a,this._cursor[1]=h),e&&(o||(o=" ")),o)){var l=function(t,e){return"[0;38;5;"+X(t)+";48;5;"+X(e)+"m"}(n,s);if(l!==this._lastColor&&(process.stdout.write(l),this._lastColor=l),"\t"!=o){var u=[].concat(o);process.stdout.write(u[0])}this._cursor[0]++,this._cursor[0]>=c[0]&&(this._cursor[0]=0,this._cursor[1]++)}},o.computeFontSize=function(){throw new Error("Terminal backend has no notion of font size")},o.eventToPosition=function(t,e){return[t,e]},o.computeSize=function(){return[process.stdout.columns,process.stdout.rows]},r}(o),B=/%([bc]){([^}]*)}/g;function Y(t,e){var i=[],r=0;t.replace(B,(function(e,o,n,s){var a=t.substring(r,s);return a.length&&i.push({type:0,value:a}),i.push({type:"c"==o?2:3,value:n.trim()}),r=s+e.length,""}));var o=t.substring(r);return o.length&&i.push({type:0,value:o}),function(t,e){e||(e=1/0);for(var i=0,r=0,o=-1;i<t.length;){var n=t[i];if(1==n.type&&(r=0,o=-1),0==n.type){for(;0==r&&" "==n.value.charAt(0);)n.value=n.value.substring(1);var s=n.value.indexOf("\n");if(-1!=s){n.value=G(t,i,s,!0);for(var a=n.value.split("");a.length&&" "==a[a.length-1];)a.pop();n.value=a.join("")}if(n.value.length){if(r+n.value.length>e){for(var h=-1;;){var c=n.value.indexOf(" ",h+1);if(-1==c)break;if(r+c>e)break;h=c}if(-1!=h)n.value=G(t,i,h,!0);else if(-1!=o){var l=t[o],u=l.value.lastIndexOf(" ");l.value=G(t,o,u,!0),i=o}else n.value=G(t,i,e-r,!1)}else r+=n.value.length,-1!=n.value.indexOf(" ")&&(o=i);i++}else t.splice(i,1)}else i++}t.push({type:1});for(var _=null,f=0;f<t.length;f++){var p=t[f];switch(p.type){case 0:_=p;break;case 1:if(_){for(var d=_.value.split("");d.length&&" "==d[d.length-1];)d.pop();_.value=d.join("")}_=null}}return t.pop(),t}(i,e)}function G(t,e,i,r){var o={type:1},n={type:0,value:t[e].value.substring(i+(r?1:0))};return t.splice(e+1,0,o,n),t[e].value.substring(0,i)}var q=Object.freeze({__proto__:null,TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_BG:3,measure:function(t,e){for(var i={width:0,height:1},r=Y(t,e),o=0,n=0;n<r.length;n++){var s=r[n];switch(s.type){case 0:o+=s.value.length;break;case 1:i.height++,i.width=Math.max(i.width,o),o=0}}return i.width=Math.max(i.width,o),i},tokenize:Y}),Q={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},J={hex:f,rect:d,tile:v,"tile-gl":M,"tile-gles2":L,term:H},Z={width:80,height:25,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1},$=function(){function t(t){void 0===t&&(t={}),this._data={},this._dirty=!1,this._options={},t=Object.assign({},Z,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}var e=t.prototype;return e.DEBUG=function(t,e,i){var r=[this._options.bg,this._options.fg];this.draw(t,e,null,null,r[i%r.length])},e.clear=function(){this._data={},this._dirty=!0},e.setOptions=function(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){var e=J[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this},e.getOptions=function(){return this._options},e.getContainer=function(){return this._backend.getContainer()},e.computeSize=function(t,e){return this._backend.computeSize(t,e)},e.computeFontSize=function(t,e){return this._backend.computeFontSize(t,e)},e.computeTileSize=function(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]},e.eventToPosition=function(t){var e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)},e.draw=function(t,e,i,r,o){r||(r=this._options.fg),o||(o=this._options.bg);var n=t+","+e;this._data[n]=[t,e,i,r,o],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[n]=!0)},e.drawOver=function(t,e,i,r,o){var n=t+","+e,s=this._data[n];s?(s[2]=i||s[2],s[3]=r||s[3],s[4]=o||s[4]):this.draw(t,e,i,r,o)},e.drawText=function(t,e,i,r){var o=null,n=null,s=t,a=e,h=1;r||(r=this._options.width-t);for(var c=Y(i,r);c.length;){var l=c.shift();switch(l.type){case 0:for(var u=!1,_=!1,f=!1,p=!1,d=0;d<l.value.length;d++){var g=l.value.charCodeAt(d),v=l.value.charAt(d);if("term"===this._options.layout){var m=g>>8;if(17===m||m>=46&&m<=159||m>=172&&m<=215||g>=43360&&g<=43391){this.draw(s+0,a,v,o,n),this.draw(s+1,a,"\t",o,n),s+=2;continue}}f=g>65280&&g<65377||g>65500&&g<65512||g>65518,u=32==v.charCodeAt(0)||12288==v.charCodeAt(0),!p||f||u||s++,f&&!_&&s++,this.draw(s++,a,v,o,n),_=u,p=f}break;case 2:o=l.value||null;break;case 3:n=l.value||null;break;case 1:s=t,a++,h++}}return h},e._tick=function(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty)for(var t in this._backend.clear(),this._data)this._draw(t,!1);else for(var e in this._dirty)this._draw(e,!0);this._dirty=!1}},e._draw=function(t,e){var i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)},t}();$.Rect=d,$.Hex=f,$.Tile=v,$.TileGL=M,$.TileGLES2=L,$.Term=H;var tt=function(){function t(t){this._options={words:!1,order:3,prior:.001},Object.assign(this._options,t),this._boundary=String.fromCharCode(0),this._suffix=this._boundary,this._prefix=[];for(var e=0;e<this._options.order;e++)this._prefix.push(this._boundary);this._priorValues={},this._priorValues[this._boundary]=this._options.prior,this._data={}}var e=t.prototype;return e.clear=function(){this._data={},this._priorValues={}},e.generate=function(){for(var t=[this._sample(this._prefix)];t[t.length-1]!=this._boundary;)t.push(this._sample(t));return this._join(t.slice(0,-1))},e.observe=function(t){for(var e=this._split(t),i=0;i<e.length;i++)this._priorValues[e[i]]=this._options.prior;e=this._prefix.concat(e).concat(this._suffix);for(var r=this._options.order;r<e.length;r++)for(var o=e.slice(r-this._options.order,r),n=e[r],s=0;s<o.length;s++){var a=o.slice(s);this._observeEvent(a,n)}},e.getStats=function(){var t=[],e=Object.keys(this._priorValues).length;e--,t.push("distinct samples: "+e);var i=Object.keys(this._data).length,r=0;for(var o in this._data)r+=Object.keys(this._data[o]).length;return t.push("dictionary size (contexts): "+i),t.push("dictionary size (events): "+r),t.join(", ")},e._split=function(t){return t.split(this._options.words?/\s+/:"")},e._join=function(t){return t.join(this._options.words?" ":"")},e._observeEvent=function(t,e){var i=this._join(t);i in this._data||(this._data[i]={});var r=this._data[i];e in r||(r[e]=0),r[e]++},e._sample=function(t){t=this._backoff(t);var e=this._join(t),i=this._data[e],o={};if(this._options.prior){for(var n in this._priorValues)o[n]=this._priorValues[n];for(var s in i)o[s]+=i[s]}else o=i;return r.getWeightedValue(o)},e._backoff=function(t){for(t.length>this._options.order?t=t.slice(-this._options.order):t.length<this._options.order&&(t=this._prefix.slice(0,this._options.order-t.length).concat(t));!(this._join(t)in this._data)&&t.length>0;)t=t.slice(1);return t},t}();function et(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(i)return(i=i.call(t)).next.bind(i);if(Array.isArray(t)||(i=function(t,e){if(t){if("string"==typeof t)return it(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?it(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function it(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,r=new Array(e);i<e;i++)r[i]=t[i];return r}var rt=function(){function t(){this.heap=[],this.timestamp=0}var e=t.prototype;return e.lessThan=function(t,e){return t.key==e.key?t.timestamp<e.timestamp:t.key<e.key},e.shift=function(t){this.heap=this.heap.map((function(e){var i=e.key,r=e.value,o=e.timestamp;return{key:i+t,value:r,timestamp:o}}))},e.len=function(){return this.heap.length},e.push=function(t,e){this.timestamp+=1;var i=this.len();this.heap.push({value:t,timestamp:this.timestamp,key:e}),this.updateUp(i)},e.pop=function(){if(0==this.len())throw new Error("no element to pop");var t=this.heap[0];return this.len()>1?(this.heap[0]=this.heap.pop(),this.updateDown(0)):this.heap.pop(),t},e.find=function(t){for(var e=0;e<this.len();e++)if(t==this.heap[e].value)return this.heap[e];return null},e.remove=function(t){for(var e=null,i=0;i<this.len();i++)t==this.heap[i].value&&(e=i);if(null===e)return!1;if(this.len()>1){var r=this.heap.pop();return r.value!=t&&(this.heap[e]=r,this.updateDown(e)),!0}return this.heap.pop(),!0},e.parentNode=function(t){return Math.floor((t-1)/2)},e.leftChildNode=function(t){return 2*t+1},e.rightChildNode=function(t){return 2*t+2},e.existNode=function(t){return t>=0&&t<this.heap.length},e.swap=function(t,e){var i=this.heap[t];this.heap[t]=this.heap[e],this.heap[e]=i},e.minNode=function(t){for(var e,i=t.filter(this.existNode.bind(this)),r=i[0],o=et(i);!(e=o()).done;){var n=e.value;this.lessThan(this.heap[n],this.heap[r])&&(r=n)}return r},e.updateUp=function(t){if(0!=t){var e=this.parentNode(t);this.existNode(e)&&this.lessThan(this.heap[t],this.heap[e])&&(this.swap(t,e),this.updateUp(e))}},e.updateDown=function(t){var e=this.leftChildNode(t),i=this.rightChildNode(t);if(this.existNode(e)){var r=this.minNode([t,e,i]);r!=t&&(this.swap(t,r),this.updateDown(r))}},e.debugPrint=function(){console.log(this.heap)},t}(),ot=function(){function t(){this._time=0,this._events=new rt}var e=t.prototype;return e.getTime=function(){return this._time},e.clear=function(){return this._events=new rt,this},e.add=function(t,e){this._events.push(t,e)},e.get=function(){if(!this._events.len())return null;var t=this._events.pop(),e=t.key,i=t.value;return e>0&&(this._time+=e,this._events.shift(-e)),i},e.getEventTime=function(t){var e=this._events.find(t);if(e)return e.key},e.remove=function(t){return this._events.remove(t)},t}(),nt=function(){function t(){this._queue=new ot,this._repeat=[],this._current=null}var e=t.prototype;return e.getTime=function(){return this._queue.getTime()},e.add=function(t,e){return e&&this._repeat.push(t),this},e.getTimeOf=function(t){return this._queue.getEventTime(t)},e.clear=function(){return this._queue.clear(),this._repeat=[],this._current=null,this},e.remove=function(t){var e=this._queue.remove(t),i=this._repeat.indexOf(t);return-1!=i&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e},e.next=function(){return this._current=this._queue.get(),this._current},t}();function st(t,e){return st=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},st(t,e)}var at=function(t){var e,i;function r(){return t.apply(this,arguments)||this}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,st(e,i);var o=r.prototype;return o.add=function(e,i){return this._queue.add(e,0),t.prototype.add.call(this,e,i)},o.next=function(){return null!==this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),t.prototype.next.call(this)},r}(nt);function ht(t,e){return ht=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},ht(t,e)}var ct=function(t){var e,i;function r(){return t.apply(this,arguments)||this}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,ht(e,i);var o=r.prototype;return o.add=function(e,i,r){return this._queue.add(e,void 0!==r?r:1/e.getSpeed()),t.prototype.add.call(this,e,i)},o.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),t.prototype.next.call(this)},r}(nt);function lt(t,e){return lt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},lt(t,e)}var ut={Simple:at,Speed:ct,Action:function(t){var e,i;function r(){var e;return(e=t.call(this)||this)._defaultDuration=1,e._duration=e._defaultDuration,e}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,lt(e,i);var o=r.prototype;return o.add=function(e,i,r){return this._queue.add(e,r||this._defaultDuration),t.prototype.add.call(this,e,i)},o.clear=function(){return this._duration=this._defaultDuration,t.prototype.clear.call(this)},o.remove=function(e){return e==this._current&&(this._duration=this._defaultDuration),t.prototype.remove.call(this,e)},o.next=function(){return null!==this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),t.prototype.next.call(this)},o.setDuration=function(t){return this._current&&(this._duration=t),this},r}(nt)},_t=function(){function t(t,e){void 0===e&&(e={}),this._lightPasses=t,this._options=Object.assign({topology:8},e)}return t.prototype._getCircle=function(t,e,i){var r,o,n,s=[];switch(this._options.topology){case 4:o=1,n=[0,1],r=[Q[8][7],Q[8][1],Q[8][3],Q[8][5]];break;case 6:r=Q[6],o=1,n=[-1,1];break;case 8:r=Q[4],o=2,n=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}for(var a=t+n[0]*i,h=e+n[1]*i,c=0;c<r.length;c++)for(var l=0;l<i*o;l++)s.push([a,h]),a+=r[c][0],h+=r[c][1];return s},t}();function ft(t,e){return ft=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},ft(t,e)}var pt=function(t){var e,i;function r(){return t.apply(this,arguments)||this}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,ft(e,i);var o=r.prototype;return o.compute=function(t,e,i,r){if(r(t,e,0,1),this._lightPasses(t,e))for(var o,n,s,a,h,c=[],l=1;l<=i;l++)for(var u=this._getCircle(t,e,l),_=360/u.length,f=0;f<u.length;f++)if(s=u[f][0],a=u[f][1],n=(o=_*(f-.5))+_,h=!this._lightPasses(s,a),this._visibleCoords(Math.floor(o),Math.ceil(n),h,c)&&r(s,a,l,1),2==c.length&&0==c[0]&&360==c[1])return},o._visibleCoords=function(t,e,i,r){if(t<0){var o=this._visibleCoords(0,e,i,r),n=this._visibleCoords(360+t,360,i,r);return o||n}for(var s=0;s<r.length&&r[s]<t;)s++;if(s==r.length)return i&&r.push(t,e),!0;var a=0;if(s%2){for(;s<r.length&&r[s]<e;)s++,a++;return 0!=a&&(i&&(a%2?r.splice(s-a,a,e):r.splice(s-a,a)),!0)}for(;s<r.length&&r[s]<e;)s++,a++;return(t!=r[s-a]||1!=a)&&(i&&(a%2?r.splice(s-a,a,t):r.splice(s-a,a,t,e)),!0)},r}(_t);function dt(t,e){return dt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},dt(t,e)}var gt=function(t){var e,i;function r(){return t.apply(this,arguments)||this}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,dt(e,i);var o=r.prototype;return o.compute=function(t,e,i,r){if(r(t,e,0,1),this._lightPasses(t,e))for(var o,n,s,a,h,c,l=[],u=1;u<=i;u++)for(var _=this._getCircle(t,e,u),f=_.length,p=0;p<f;p++)if(o=_[p][0],n=_[p][1],a=[p?2*p-1:2*f-1,2*f],h=[2*p+1,2*f],s=!this._lightPasses(o,n),(c=this._checkVisibility(a,h,s,l))&&r(o,n,u,c),2==l.length&&0==l[0][0]&&l[1][0]==l[1][1])return},o._checkVisibility=function(t,e,i,r){if(t[0]>e[0])return(this._checkVisibility(t,[t[1],t[1]],i,r)+this._checkVisibility([0,1],e,i,r))/2;for(var o=0,n=!1;o<r.length;){var s=r[o],a=s[0]*t[1]-t[0]*s[1];if(a>=0){0!=a||o%2||(n=!0);break}o++}for(var h=r.length,c=!1;h--;){var l=r[h],u=e[0]*l[1]-l[0]*e[1];if(u>=0){0==u&&h%2&&(c=!0);break}}var _,f=!0;if((o==h&&(n||c)||n&&c&&o+1==h&&h%2||o>h&&o%2)&&(f=!1),!f)return 0;var p=h-o+1;if(p%2)if(o%2){var d=r[o];_=(e[0]*d[1]-d[0]*e[1])/(d[1]*e[1]),i&&r.splice(o,p,e)}else{var g=r[h];_=(g[0]*t[1]-t[0]*g[1])/(t[1]*g[1]),i&&r.splice(o,p,t)}else{if(!(o%2))return i&&r.splice(o,p,t,e),1;var v=r[o],m=r[h];_=(m[0]*v[1]-v[0]*m[1])/(v[1]*m[1]),i&&r.splice(o,p)}return _/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))},r}(_t);function vt(t,e){return vt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},vt(t,e)}var mt=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]],bt=function(t){var e,i;function r(){return t.apply(this,arguments)||this}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,vt(e,i);var o=r.prototype;return o.compute=function(t,e,i,r){r(t,e,0,1);for(var o=0;o<mt.length;o++)this._renderOctant(t,e,mt[o],i,r)},o.compute180=function(t,e,i,r,o){o(t,e,0,1);var n=(r-1+8)%8,s=(r-2+8)%8,a=(r+1+8)%8;this._renderOctant(t,e,mt[s],i,o),this._renderOctant(t,e,mt[n],i,o),this._renderOctant(t,e,mt[r],i,o),this._renderOctant(t,e,mt[a],i,o)},o.compute90=function(t,e,i,r,o){o(t,e,0,1);var n=(r-1+8)%8;this._renderOctant(t,e,mt[r],i,o),this._renderOctant(t,e,mt[n],i,o)},o._renderOctant=function(t,e,i,r,o){this._castVisibility(t,e,1,1,0,r+1,i[0],i[1],i[2],i[3],o)},o._castVisibility=function(t,e,i,r,o,n,s,a,h,c,l){if(!(r<o))for(var u=i;u<=n;u++){for(var _=-u-1,f=-u,p=!1,d=0;_<=0;){var g=t+(_+=1)*s+f*a,v=e+_*h+f*c,m=(_-.5)/(f+.5),b=(_+.5)/(f-.5);if(!(b>r)){if(m<o)break;if(_*_+f*f<n*n&&l(g,v,u,1),p){if(!this._lightPasses(g,v)){d=b;continue}p=!1,r=d}else!this._lightPasses(g,v)&&u<n&&(p=!0,this._castVisibility(t,e,u+1,r,m,n,s,a,h,c,l),d=b)}}if(p)break}},r}(_t),yt={DiscreteShadowcasting:pt,PreciseShadowcasting:gt,RecursiveShadowcasting:bt},wt=function(){function t(t,e){void 0===t&&(t=80),void 0===e&&(e=25),this._width=t,this._height=e}return t.prototype._fillMap=function(t){for(var e=[],i=0;i<this._width;i++){e.push([]);for(var r=0;r<this._height;r++)e[i].push(t)}return e},t}();function Ot(t,e){return Ot=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Ot(t,e)}var Pt=function(t){var e,i;function r(){return t.apply(this,arguments)||this}return i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,Ot(e,i),r.prototype.create=function(t){for(var e=this._width-1,i=this._height-1,r=0;r<=e;r++)for(var o=0;o<=i;o++)t(r,o,r&&o&&r<e&&o<i?0:1);return this},r}(wt);function Et(t,e){return Et=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Et(t,e)}var xt=function(t){var e,i;function r(e,i){var r;return(r=t.call(this,e,i)||this)._rooms=[],r._corridors=[],r}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,Et(e,i);var o=r.prototype;return o.getRooms=function(){return this._rooms},o.getCorridors=function(){return this._corridors},r}(wt);function Tt(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,St(t,e)}function St(t,e){return St=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},St(t,e)}var Ct=function(){},Rt=function(t){function e(e,i,r,o,n,s){var a;return(a=t.call(this)||this)._x1=e,a._y1=i,a._x2=r,a._y2=o,a._doors={},void 0!==n&&void 0!==s&&a.addDoor(n,s),a}Tt(e,t),e.createRandomAt=function(t,e,i,o,n){var s=n.roomWidth[0],a=n.roomWidth[1],h=r.getUniformInt(s,a);s=n.roomHeight[0],a=n.roomHeight[1];var c=r.getUniformInt(s,a);if(1==i){var l=e-Math.floor(r.getUniform()*c);return new this(t+1,l,t+h,l+c-1,t,e)}if(-1==i){var u=e-Math.floor(r.getUniform()*c);return new this(t-h,u,t-1,u+c-1,t,e)}if(1==o){var _=t-Math.floor(r.getUniform()*h);return new this(_,e+1,_+h-1,e+c,t,e)}if(-1==o){var f=t-Math.floor(r.getUniform()*h);return new this(f,e-c,f+h-1,e-1,t,e)}throw new Error("dx or dy must be 1 or -1")},e.createRandomCenter=function(t,e,i){var o=i.roomWidth[0],n=i.roomWidth[1],s=r.getUniformInt(o,n);o=i.roomHeight[0],n=i.roomHeight[1];var a=r.getUniformInt(o,n),h=t-Math.floor(r.getUniform()*s),c=e-Math.floor(r.getUniform()*a);return new this(h,c,h+s-1,c+a-1)},e.createRandom=function(t,e,i){var o=i.roomWidth[0],n=i.roomWidth[1],s=r.getUniformInt(o,n);o=i.roomHeight[0],n=i.roomHeight[1];var a=r.getUniformInt(o,n),h=t-s-1,c=e-a-1,l=1+Math.floor(r.getUniform()*h),u=1+Math.floor(r.getUniform()*c);return new this(l,u,l+s-1,u+a-1)};var i=e.prototype;return i.addDoor=function(t,e){return this._doors[t+","+e]=1,this},i.getDoors=function(t){for(var e in this._doors){var i=e.split(",");t(parseInt(i[0]),parseInt(i[1]))}return this},i.clearDoors=function(){return this._doors={},this},i.addDoors=function(t){for(var e=this._x1-1,i=this._x2+1,r=this._y1-1,o=this._y2+1,n=e;n<=i;n++)for(var s=r;s<=o;s++)n!=e&&n!=i&&s!=r&&s!=o||t(n,s)||this.addDoor(n,s);return this},i.debug=function(){console.log("room",this._x1,this._y1,this._x2,this._y2)},i.isValid=function(t,e){for(var i=this._x1-1,r=this._x2+1,o=this._y1-1,n=this._y2+1,s=i;s<=r;s++)for(var a=o;a<=n;a++)if(s==i||s==r||a==o||a==n){if(!t(s,a))return!1}else if(!e(s,a))return!1;return!0},i.create=function(t){for(var e=this._x1-1,i=this._x2+1,r=this._y1-1,o=this._y2+1,n=e;n<=i;n++)for(var s=r;s<=o;s++)t(n,s,n+","+s in this._doors?2:n==e||n==i||s==r||s==o?1:0)},i.getCenter=function(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]},i.getLeft=function(){return this._x1},i.getRight=function(){return this._x2},i.getTop=function(){return this._y1},i.getBottom=function(){return this._y2},e}(Ct),Mt=function(t){function e(e,i,r,o){var n;return(n=t.call(this)||this)._startX=e,n._startY=i,n._endX=r,n._endY=o,n._endsWithAWall=!0,n}Tt(e,t),e.createRandomAt=function(t,e,i,o,n){var s=n.corridorLength[0],a=n.corridorLength[1],h=r.getUniformInt(s,a);return new this(t,e,t+i*h,e+o*h)};var i=e.prototype;return i.debug=function(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)},i.isValid=function(t,e){var i=this._startX,r=this._startY,o=this._endX-i,n=this._endY-r,s=1+Math.max(Math.abs(o),Math.abs(n));o&&(o/=Math.abs(o)),n&&(n/=Math.abs(n));for(var a=n,h=-o,c=!0,l=0;l<s;l++){var u=i+l*o,_=r+l*n;if(e(u,_)||(c=!1),t(u+a,_+h)||(c=!1),t(u-a,_-h)||(c=!1),!c){s=l,this._endX=u-o,this._endY=_-n;break}}if(0==s)return!1;if(1==s&&t(this._endX+o,this._endY+n))return!1;var f=!t(this._endX+o+a,this._endY+n+h),p=!t(this._endX+o-a,this._endY+n-h);return this._endsWithAWall=t(this._endX+o,this._endY+n),!f&&!p||!this._endsWithAWall},i.create=function(t){var e=this._startX,i=this._startY,r=this._endX-e,o=this._endY-i,n=1+Math.max(Math.abs(r),Math.abs(o));r&&(r/=Math.abs(r)),o&&(o/=Math.abs(o));for(var s=0;s<n;s++)t(e+s*r,i+s*o,0);return!0},i.createPriorityWalls=function(t){if(this._endsWithAWall){var e=this._startX,i=this._startY,r=this._endX-e,o=this._endY-i;r&&(r/=Math.abs(r)),o&&(o/=Math.abs(o));var n=o,s=-r;t(this._endX+r,this._endY+o),t(this._endX+n,this._endY+s),t(this._endX-n,this._endY-s)}},e}(Ct);function Vt(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function At(t,e){return At=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},At(t,e)}var Kt=function(t){var e,i;function o(e,i,r){var o;return(o=t.call(this,e,i)||this)._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},Object.assign(o._options,r),o._map=[],o._dug=0,o._roomAttempts=20,o._corridorAttempts=20,o._connected=[],o._unconnected=[],o._digCallback=o._digCallback.bind(Vt(o)),o._canBeDugCallback=o._canBeDugCallback.bind(Vt(o)),o._isWallCallback=o._isWallCallback.bind(Vt(o)),o}i=t,(e=o).prototype=Object.create(i.prototype),e.prototype.constructor=e,At(e,i);var n=o.prototype;return n.create=function(t){for(var e=Date.now();;){if(Date.now()-e>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(t)for(var i=0;i<this._width;i++)for(var r=0;r<this._height;r++)t(i,r,this._map[i][r]);return this},n._generateRooms=function(){var t,e=this._width-2,i=this._height-2;do{if(t=this._generateRoom(),this._dug/(e*i)>this._options.roomDugPercentage)break}while(t)},n._generateRoom=function(){for(var t=0;t<this._roomAttempts;){t++;var e=Rt.createRandom(this._width,this._height,this._options);if(e.isValid(this._isWallCallback,this._canBeDugCallback))return e.create(this._digCallback),this._rooms.push(e),e}return null},n._generateCorridors=function(){for(var t=0;t<this._corridorAttempts;){t++,this._corridors=[],this._map=this._fillMap(1);for(var e=0;e<this._rooms.length;e++){var i=this._rooms[e];i.clearDoors(),i.create(this._digCallback)}for(this._unconnected=r.shuffle(this._rooms.slice()),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){var o=r.getItem(this._connected);if(!o)break;var n=this._closestRoom(this._unconnected,o);if(!n)break;var s=this._closestRoom(this._connected,n);if(!s)break;if(!this._connectRooms(n,s))break;if(!this._unconnected.length)return!0}}return!1},n._closestRoom=function(t,e){for(var i=1/0,r=e.getCenter(),o=null,n=0;n<t.length;n++){var s=t[n],a=s.getCenter(),h=a[0]-r[0],c=a[1]-r[1],l=h*h+c*c;l<i&&(i=l,o=s)}return o},n._connectRooms=function(t,e){var i,r,o,n,s,a,h,c=t.getCenter(),l=e.getCenter(),u=l[0]-c[0],_=l[1]-c[1];if(Math.abs(u)<Math.abs(_)?(n=(2+(o=_>0?2:0))%4,s=e.getLeft(),a=e.getRight(),h=0):(n=(2+(o=u>0?1:3))%4,s=e.getTop(),a=e.getBottom(),h=1),!(i=this._placeInWall(t,o)))return!1;if(i[h]>=s&&i[h]<=a){r=i.slice();var f=0;switch(n){case 0:f=e.getTop()-1;break;case 1:f=e.getRight()+1;break;case 2:f=e.getBottom()+1;break;case 3:f=e.getLeft()-1}r[(h+1)%2]=f,this._digLine([i,r])}else if(i[h]<s-1||i[h]>a+1){var p=i[h]-l[h],d=0;switch(n){case 0:case 1:d=p<0?3:1;break;case 2:case 3:d=p<0?1:3}if(n=(n+d)%4,!(r=this._placeInWall(e,n)))return!1;var g=[0,0];g[h]=i[h];var v=(h+1)%2;g[v]=r[v],this._digLine([i,g,r])}else{var m=(h+1)%2;if(!(r=this._placeInWall(e,n)))return!1;var b=Math.round((r[m]+i[m])/2),y=[0,0],w=[0,0];y[h]=i[h],y[m]=b,w[h]=r[h],w[m]=b,this._digLine([i,y,w,r])}return t.addDoor(i[0],i[1]),e.addDoor(r[0],r[1]),-1!=(h=this._unconnected.indexOf(t))&&(this._unconnected.splice(h,1),this._connected.push(t)),-1!=(h=this._unconnected.indexOf(e))&&(this._unconnected.splice(h,1),this._connected.push(e)),!0},n._placeInWall=function(t,e){var i=[0,0],o=[0,0],n=0;switch(e){case 0:o=[1,0],i=[t.getLeft(),t.getTop()-1],n=t.getRight()-t.getLeft()+1;break;case 1:o=[0,1],i=[t.getRight()+1,t.getTop()],n=t.getBottom()-t.getTop()+1;break;case 2:o=[1,0],i=[t.getLeft(),t.getBottom()+1],n=t.getRight()-t.getLeft()+1;break;case 3:o=[0,1],i=[t.getLeft()-1,t.getTop()],n=t.getBottom()-t.getTop()+1}for(var s=[],a=-2,h=0;h<n;h++){var c=i[0]+h*o[0],l=i[1]+h*o[1];s.push(null),1==this._map[c][l]?a!=h-1&&(s[h]=[c,l]):(a=h,h&&(s[h-1]=null))}for(var u=s.length-1;u>=0;u--)s[u]||s.splice(u,1);return s.length?r.getItem(s):null},n._digLine=function(t){for(var e=1;e<t.length;e++){var i=t[e-1],r=t[e],o=new Mt(i[0],i[1],r[0],r[1]);o.create(this._digCallback),this._corridors.push(o)}},n._digCallback=function(t,e,i){this._map[t][e]=i,0==i&&this._dug++},n._isWallCallback=function(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]},n._canBeDugCallback=function(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]},o}(xt);function kt(t,e){return kt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},kt(t,e)}var Ut=function(t){var e,i;function o(e,i,r){var o;return void 0===r&&(r={}),(o=t.call(this,e,i)||this)._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},o.setOptions(r),o._dirs=Q[o._options.topology],o._map=o._fillMap(0),o}i=t,(e=o).prototype=Object.create(i.prototype),e.prototype.constructor=e,kt(e,i);var n=o.prototype;return n.randomize=function(t){for(var e=0;e<this._width;e++)for(var i=0;i<this._height;i++)this._map[e][i]=r.getUniform()<t?1:0;return this},n.setOptions=function(t){Object.assign(this._options,t)},n.set=function(t,e,i){this._map[t][e]=i},n.create=function(t){for(var e=this._fillMap(0),i=this._options.born,r=this._options.survive,o=0;o<this._height;o++){var n=1,s=0;6==this._options.topology&&(n=2,s=o%2);for(var a=s;a<this._width;a+=n){var h=this._map[a][o],c=this._getNeighbors(a,o);h&&-1!=r.indexOf(c)?e[a][o]=1:h||-1==i.indexOf(c)||(e[a][o]=1)}}this._map=e,t&&this._serviceCallback(t)},n._serviceCallback=function(t){for(var e=0;e<this._height;e++){var i=1,r=0;6==this._options.topology&&(i=2,r=e%2);for(var o=r;o<this._width;o+=i)t(o,e,this._map[o][e])}},n._getNeighbors=function(t,e){for(var i=0,r=0;r<this._dirs.length;r++){var o=this._dirs[r],n=t+o[0],s=e+o[1];n<0||n>=this._width||s<0||s>=this._height||(i+=1==this._map[n][s]?1:0)}return i},n.connect=function(t,e,i){e||(e=0);var o=[],n={},s=1,a=[0,0];6==this._options.topology&&(s=2,a=[0,1]);for(var h=0;h<this._height;h++)for(var c=a[h%2];c<this._width;c+=s)if(this._freeSpace(c,h,e)){var l=[c,h];n[this._pointKey(l)]=l,o.push([c,h])}var u=o[r.getUniformInt(0,o.length-1)],_=this._pointKey(u),f={};for(f[_]=u,delete n[_],this._findConnected(f,n,[u],!1,e);Object.keys(n).length>0;){var p=this._getFromTo(f,n),d=p[0],g=p[1],v={};v[this._pointKey(d)]=d,this._findConnected(v,n,[d],!0,e);var m=6==this._options.topology?this._tunnelToConnected6:this._tunnelToConnected;for(var b in m.call(this,g,d,f,n,e,i),v){var y=v[b];this._map[y[0]][y[1]]=e,f[b]=y,delete n[b]}}t&&this._serviceCallback(t)},n._getFromTo=function(t,e){for(var i=[0,0],o=[0,0],n=Object.keys(t),s=Object.keys(e),a=0;a<5;a++){if(n.length<s.length){var h=n;o=t[h[r.getUniformInt(0,h.length-1)]],i=this._getClosest(o,e)}else{var c=s;i=e[c[r.getUniformInt(0,c.length-1)]],o=this._getClosest(i,t)}if((i[0]-o[0])*(i[0]-o[0])+(i[1]-o[1])*(i[1]-o[1])<64)break}return[i,o]},n._getClosest=function(t,e){var i=null,r=null;for(var o in e){var n=e[o],s=(n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1]);(null==r||s<r)&&(r=s,i=n)}return i},n._findConnected=function(t,e,i,r,o){for(;i.length>0;){var n=i.splice(0,1)[0],s=void 0;s=6==this._options.topology?[[n[0]+2,n[1]],[n[0]+1,n[1]-1],[n[0]-1,n[1]-1],[n[0]-2,n[1]],[n[0]-1,n[1]+1],[n[0]+1,n[1]+1]]:[[n[0]+1,n[1]],[n[0]-1,n[1]],[n[0],n[1]+1],[n[0],n[1]-1]];for(var a=0;a<s.length;a++){var h=this._pointKey(s[a]);null==t[h]&&this._freeSpace(s[a][0],s[a][1],o)&&(t[h]=s[a],r||delete e[h],i.push(s[a]))}}},n._tunnelToConnected=function(t,e,i,r,o,n){var s,a;e[0]<t[0]?(s=e,a=t):(s=t,a=e);for(var h=s[0];h<=a[0];h++){this._map[h][s[1]]=o;var c=[h,s[1]],l=this._pointKey(c);i[l]=c,delete r[l]}n&&s[0]<a[0]&&n(s,[a[0],s[1]]);var u=a[0];e[1]<t[1]?(s=e,a=t):(s=t,a=e);for(var _=s[1];_<a[1];_++){this._map[u][_]=o;var f=[u,_],p=this._pointKey(f);i[p]=f,delete r[p]}n&&s[1]<a[1]&&n([a[0],s[1]],[a[0],a[1]])},n._tunnelToConnected6=function(t,e,i,r,o,n){var s,a;e[0]<t[0]?(s=e,a=t):(s=t,a=e);for(var h=s[0],c=s[1];h!=a[0]||c!=a[1];){var l=2;c<a[1]?(c++,l=1):c>a[1]&&(c--,l=1),h<a[0]?h+=l:h>a[0]||a[1]%2?h-=l:h+=l,this._map[h][c]=o;var u=[h,c],_=this._pointKey(u);i[_]=u,delete r[_]}n&&n(e,t)},n._freeSpace=function(t,e,i){return t>=0&&t<this._width&&e>=0&&e<this._height&&this._map[t][e]==i},n._pointKey=function(t){return t[0]+"."+t[1]},o}(wt);function It(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function Lt(t,e){return Lt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Lt(t,e)}var Dt={room:Rt,corridor:Mt},Nt=function(t){var e,i;function o(e,i,r){var o;return void 0===r&&(r={}),(o=t.call(this,e,i)||this)._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},r),o._features={room:4,corridor:4},o._map=[],o._featureAttempts=20,o._walls={},o._dug=0,o._digCallback=o._digCallback.bind(It(o)),o._canBeDugCallback=o._canBeDugCallback.bind(It(o)),o._isWallCallback=o._isWallCallback.bind(It(o)),o._priorityWallCallback=o._priorityWallCallback.bind(It(o)),o}i=t,(e=o).prototype=Object.create(i.prototype),e.prototype.constructor=e,Lt(e,i);var n=o.prototype;return n.create=function(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;var e=(this._width-2)*(this._height-2);this._firstRoom();var i,r=Date.now();do{if(i=0,Date.now()-r>this._options.timeLimit)break;var o=this._findWall();if(!o)break;var n=o.split(","),s=parseInt(n[0]),a=parseInt(n[1]),h=this._getDiggingDirection(s,a);if(h){var c=0;do{if(c++,this._tryFeature(s,a,h[0],h[1])){this._removeSurroundingWalls(s,a),this._removeSurroundingWalls(s-h[0],a-h[1]);break}}while(c<this._featureAttempts);for(var l in this._walls)this._walls[l]>1&&i++}}while(this._dug/e<this._options.dugPercentage||i);if(this._addDoors(),t)for(var u=0;u<this._width;u++)for(var _=0;_<this._height;_++)t(u,_,this._map[u][_]);return this._walls={},this._map=[],this},n._digCallback=function(t,e,i){0==i||2==i?(this._map[t][e]=0,this._dug++):this._walls[t+","+e]=1},n._isWallCallback=function(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]},n._canBeDugCallback=function(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]},n._priorityWallCallback=function(t,e){this._walls[t+","+e]=2},n._firstRoom=function(){var t=Math.floor(this._width/2),e=Math.floor(this._height/2),i=Rt.createRandomCenter(t,e,this._options);this._rooms.push(i),i.create(this._digCallback)},n._findWall=function(){var t=[],e=[];for(var i in this._walls)2==this._walls[i]?e.push(i):t.push(i);var o=e.length?e:t;if(!o.length)return null;var n=r.getItem(o.sort());return delete this._walls[n],n},n._tryFeature=function(t,e,i,o){var n=r.getWeightedValue(this._features),s=Dt[n].createRandomAt(t,e,i,o,this._options);return!!s.isValid(this._isWallCallback,this._canBeDugCallback)&&(s.create(this._digCallback),s instanceof Rt&&this._rooms.push(s),s instanceof Mt&&(s.createPriorityWalls(this._priorityWallCallback),this._corridors.push(s)),!0)},n._removeSurroundingWalls=function(t,e){for(var i=Q[4],r=0;r<i.length;r++){var o=i[r],n=t+o[0],s=e+o[1];delete this._walls[n+","+s],n=t+2*o[0],s=e+2*o[1],delete this._walls[n+","+s]}},n._getDiggingDirection=function(t,e){if(t<=0||e<=0||t>=this._width-1||e>=this._height-1)return null;for(var i=null,r=Q[4],o=0;o<r.length;o++){var n=r[o],s=t+n[0],a=e+n[1];if(!this._map[s][a]){if(i)return null;i=n}}return i?[-i[0],-i[1]]:null},n._addDoors=function(){var t=this._map;function e(e,i){return 1==t[e][i]}for(var i=0;i<this._rooms.length;i++){var r=this._rooms[i];r.clearDoors(),r.addDoors(e)}},o}(xt);function jt(t,e){return jt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},jt(t,e)}function zt(t,e,i){i[e[t+1]]=i[t],e[i[t]]=e[t+1],i[t]=t+1,e[t+1]=t}function Ft(t,e,i){i[e[t]]=i[t],e[i[t]]=e[t],i[t]=t,e[t]=t}var Wt=function(t){var e,i;function o(){return t.apply(this,arguments)||this}return i=t,(e=o).prototype=Object.create(i.prototype),e.prototype.constructor=e,jt(e,i),o.prototype.create=function(t){for(var e,i=this._fillMap(1),o=Math.ceil((this._width-2)/2),n=9/24,s=[],a=[],h=0;h<o;h++)s.push(h),a.push(h);for(s.push(o-1),e=1;e+3<this._height;e+=2)for(var c=0;c<o;c++){var l=2*c+1,u=e;i[l][u]=0,c!=s[c+1]&&r.getUniform()>n&&(zt(c,s,a),i[l+1][u]=0),c!=s[c]&&r.getUniform()>n?Ft(c,s,a):i[l][u+1]=0}for(var _=0;_<o;_++){var f=2*_+1,p=e;i[f][p]=0,_!=s[_+1]&&(_==s[_]||r.getUniform()>n)&&(zt(_,s,a),i[f+1][p]=0),Ft(_,s,a)}for(var d=0;d<this._width;d++)for(var g=0;g<this._height;g++)t(d,g,i[d][g]);return this},o}(wt);function Xt(t,e){return Xt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Xt(t,e)}var Ht=function(t){var e,i;function o(){for(var e,i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];return(e=t.call.apply(t,[this].concat(r))||this)._stack=[],e._map=[],e}i=t,(e=o).prototype=Object.create(i.prototype),e.prototype.constructor=e,Xt(e,i);var n=o.prototype;return n.create=function(t){var e=this._width,i=this._height;this._map=[];for(var r=0;r<e;r++){this._map.push([]);for(var o=0;o<i;o++){var n=0==r||0==o||r+1==e||o+1==i;this._map[r].push(n?1:0)}}this._stack=[[1,1,e-2,i-2]],this._process();for(var s=0;s<e;s++)for(var a=0;a<i;a++)t(s,a,this._map[s][a]);return this._map=[],this},n._process=function(){for(;this._stack.length;){var t=this._stack.shift();this._partitionRoom(t)}},n._partitionRoom=function(t){for(var e=[],i=[],o=t[0]+1;o<t[2];o++){var n=this._map[o][t[1]-1],s=this._map[o][t[3]+1];!n||!s||o%2||e.push(o)}for(var a=t[1]+1;a<t[3];a++){var h=this._map[t[0]-1][a],c=this._map[t[2]+1][a];!h||!c||a%2||i.push(a)}if(e.length&&i.length){var l=r.getItem(e),u=r.getItem(i);this._map[l][u]=1;var _=[],f=[];_.push(f);for(var p=t[0];p<l;p++)this._map[p][u]=1,p%2&&f.push([p,u]);f=[],_.push(f);for(var d=l+1;d<=t[2];d++)this._map[d][u]=1,d%2&&f.push([d,u]);f=[],_.push(f);for(var g=t[1];g<u;g++)this._map[l][g]=1,g%2&&f.push([l,g]);f=[],_.push(f);for(var v=u+1;v<=t[3];v++)this._map[l][v]=1,v%2&&f.push([l,v]);for(var m=r.getItem(_),b=0;b<_.length;b++){var y=_[b];if(y!=m){var w=r.getItem(y);this._map[w[0]][w[1]]=0}}this._stack.push([t[0],t[1],l-1,u-1]),this._stack.push([l+1,t[1],t[2],u-1]),this._stack.push([t[0],u+1,l-1,t[3]]),this._stack.push([l+1,u+1,t[2],t[3]])}},o}(wt);function Bt(t,e){return Bt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Bt(t,e)}function Yt(t,e){return Yt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Yt(t,e)}var Gt={Arena:Pt,Uniform:Kt,Cellular:Ut,Digger:Nt,EllerMaze:Wt,DividedMaze:Ht,IceyMaze:function(t){var e,i;function o(e,i,r){var o;return void 0===r&&(r=0),(o=t.call(this,e,i)||this)._regularity=r,o._map=[],o}i=t,(e=o).prototype=Object.create(i.prototype),e.prototype.constructor=e,Bt(e,i);var n=o.prototype;return n.create=function(t){var e=this._width,i=this._height,o=this._fillMap(1);e-=e%2?1:2,i-=i%2?1:2;var n=0,s=0,a=0,h=0,c=0,l=!1,u=[[0,0],[0,0],[0,0],[0,0]];do{if(n=1+2*Math.floor(r.getUniform()*(e-1)/2),s=1+2*Math.floor(r.getUniform()*(i-1)/2),c||(o[n][s]=0),!o[n][s]){this._randomize(u);do{0==Math.floor(r.getUniform()*(this._regularity+1))&&this._randomize(u),l=!0;for(var _=0;_<4;_++)if(a=n+2*u[_][0],h=s+2*u[_][1],this._isFree(o,a,h,e,i)){o[a][h]=0,o[n+u[_][0]][s+u[_][1]]=0,n=a,s=h,l=!1,c++;break}}while(!l)}}while(c+1<e*i/4);for(var f=0;f<this._width;f++)for(var p=0;p<this._height;p++)t(f,p,o[f][p]);return this._map=[],this},n._randomize=function(t){for(var e=0;e<4;e++)t[e][0]=0,t[e][1]=0;switch(Math.floor(4*r.getUniform())){case 0:t[0][0]=-1,t[1][0]=1,t[2][1]=-1,t[3][1]=1;break;case 1:t[3][0]=-1,t[2][0]=1,t[1][1]=-1,t[0][1]=1;break;case 2:t[2][0]=-1,t[3][0]=1,t[0][1]=-1,t[1][1]=1;break;case 3:t[1][0]=-1,t[0][0]=1,t[3][1]=-1,t[2][1]=1}},n._isFree=function(t,e,i,r,o){return!(e<1||i<1||e>=r||i>=o)&&t[e][i]},o}(wt),Rogue:function(t){var e,i;function o(e,i,r){var o;return(o=t.call(this,e,i)||this).map=[],o.rooms=[],o.connectedCells=[],(r=Object.assign({cellWidth:3,cellHeight:3},r)).hasOwnProperty("roomWidth")||(r.roomWidth=o._calculateRoomSize(o._width,r.cellWidth)),r.hasOwnProperty("roomHeight")||(r.roomHeight=o._calculateRoomSize(o._height,r.cellHeight)),o._options=r,o}i=t,(e=o).prototype=Object.create(i.prototype),e.prototype.constructor=e,Yt(e,i);var n=o.prototype;return n.create=function(t){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),t)for(var e=0;e<this._width;e++)for(var i=0;i<this._height;i++)t(e,i,this.map[e][i]);return this},n._calculateRoomSize=function(t,e){var i=Math.floor(t/e*.8),r=Math.floor(t/e*.25);return r<2&&(r=2),i<2&&(i=2),[r,i]},n._initRooms=function(){for(var t=0;t<this._options.cellWidth;t++){this.rooms.push([]);for(var e=0;e<this._options.cellHeight;e++)this.rooms[t].push({x:0,y:0,width:0,height:0,connections:[],cellx:t,celly:e})}},n._connectRooms=function(){var t,e,i,o,n,s,a=r.getUniformInt(0,this._options.cellWidth-1),h=r.getUniformInt(0,this._options.cellHeight-1),c=!1;do{s=[0,2,4,6],s=r.shuffle(s);do{if(c=!1,t=s.pop(),e=a+Q[8][t][0],i=h+Q[8][t][1],!(e<0||e>=this._options.cellWidth||i<0||i>=this._options.cellHeight)){if((o=this.rooms[a][h]).connections.length>0&&o.connections[0][0]==e&&o.connections[0][1]==i)break;0==(n=this.rooms[e][i]).connections.length&&(n.connections.push([a,h]),this.connectedCells.push([e,i]),a=e,h=i,c=!0)}}while(s.length>0&&0==c)}while(s.length>0)},n._connectUnconnectedRooms=function(){var t,e,i,o=this._options.cellWidth,n=this._options.cellHeight;this.connectedCells=r.shuffle(this.connectedCells);for(var s=0;s<this._options.cellWidth;s++)for(var a=0;a<this._options.cellHeight;a++)if(0==(t=this.rooms[s][a]).connections.length){var h=[0,2,4,6];h=r.shuffle(h),i=!1;do{var c=h.pop(),l=s+Q[8][c][0],u=a+Q[8][c][1];if(!(l<0||l>=o||u<0||u>=n)){if(i=!0,0==(e=this.rooms[l][u]).connections.length)break;for(var _=0;_<e.connections.length;_++)if(e.connections[_][0]==s&&e.connections[_][1]==a){i=!1;break}if(i)break}}while(h.length);i?t.connections.push([e.cellx,e.celly]):console.log("-- Unable to connect room.")}},n._createRandomRoomConnections=function(){},n._createRooms=function(){for(var t,e,i,o,n,s=this._width,a=this._height,h=this._options.cellWidth,c=this._options.cellHeight,l=Math.floor(this._width/h),u=Math.floor(this._height/c),_=this._options.roomWidth,f=this._options.roomHeight,p=0;p<h;p++)for(var d=0;d<c;d++){if(0==(i=l*p)&&(i=1),0==(o=u*d)&&(o=1),t=r.getUniformInt(_[0],_[1]),e=r.getUniformInt(f[0],f[1]),d>0)for(n=this.rooms[p][d-1];o-(n.y+n.height)<3;)o++;if(p>0)for(n=this.rooms[p-1][d];i-(n.x+n.width)<3;)i++;for(var g=Math.round(r.getUniformInt(0,l-t)/2),v=Math.round(r.getUniformInt(0,u-e)/2);i+g+t>=s;)g?g--:t--;for(;o+v+e>=a;)v?v--:e--;i+=g,o+=v,this.rooms[p][d].x=i,this.rooms[p][d].y=o,this.rooms[p][d].width=t,this.rooms[p][d].height=e;for(var m=i;m<i+t;m++)for(var b=o;b<o+e;b++)this.map[m][b]=0}},n._getWallPosition=function(t,e){var i,o,n;return 1==e||3==e?(i=r.getUniformInt(t.x+1,t.x+t.width-2),n=1==e?1+(o=t.y-2):(o=t.y+t.height+1)-1,this.map[i][n]=0):(o=r.getUniformInt(t.y+1,t.y+t.height-2),n=2==e?(i=t.x+t.width+1)-1:1+(i=t.x-2),this.map[n][o]=0),[i,o]},n._drawCorridor=function(t,e){var i,o,n,s,a=e[0]-t[0],h=e[1]-t[1],c=t[0],l=t[1],u=[],_=Math.abs(a),f=Math.abs(h),p=r.getUniform(),d=p,g=1-p;for(o=a>0?2:6,n=h>0?4:0,_<f?(i=Math.ceil(f*d),u.push([n,i]),u.push([o,_]),i=Math.floor(f*g),u.push([n,i])):(i=Math.ceil(_*d),u.push([o,i]),u.push([n,f]),i=Math.floor(_*g),u.push([o,i])),this.map[c][l]=0;u.length>0;)for(s=u.pop();s[1]>0;)c+=Q[8][s[0]][0],l+=Q[8][s[0]][1],this.map[c][l]=0,s[1]=s[1]-1},n._createCorridors=function(){for(var t,e,i,r,o,n=this._options.cellWidth,s=this._options.cellHeight,a=0;a<n;a++)for(var h=0;h<s;h++){t=this.rooms[a][h];for(var c=0;c<t.connections.length;c++)e=t.connections[c],(i=this.rooms[e[0]][e[1]]).cellx>t.cellx?(r=2,o=4):i.cellx<t.cellx?(r=4,o=2):i.celly>t.celly?(r=3,o=1):(r=1,o=3),this._drawCorridor(this._getWallPosition(t,r),this._getWallPosition(i,o))}},o}(wt)},qt=function(){};function Qt(t,e){return Qt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Qt(t,e)}var Jt=.5*(Math.sqrt(3)-1),Zt=(3-Math.sqrt(3))/6,$t={Simplex:function(t){var e,i;function o(e){var i;void 0===e&&(e=256),(i=t.call(this)||this)._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];for(var o=[],n=0;n<e;n++)o.push(n);o=r.shuffle(o),i._perms=[],i._indexes=[];for(var s=0;s<2*e;s++)i._perms.push(o[s%e]),i._indexes.push(i._perms[s]%i._gradients.length);return i}return i=t,(e=o).prototype=Object.create(i.prototype),e.prototype.constructor=e,Qt(e,i),o.prototype.get=function(t,e){var i,r,o,n=this._perms,s=this._indexes,h=n.length/2,c=0,l=0,u=0,_=(t+e)*Jt,f=Math.floor(t+_),p=Math.floor(e+_),d=(f+p)*Zt,g=t-(f-d),v=e-(p-d);g>v?(r=1,o=0):(r=0,o=1);var m=g-r+Zt,b=v-o+Zt,y=g-1+2*Zt,w=v-1+2*Zt,O=a(f,h),P=a(p,h),E=.5-g*g-v*v;if(E>=0){E*=E,i=s[O+n[P]];var x=this._gradients[i];c=E*E*(x[0]*g+x[1]*v)}var T=.5-m*m-b*b;if(T>=0){T*=T,i=s[O+r+n[P+o]];var S=this._gradients[i];l=T*T*(S[0]*m+S[1]*b)}var C=.5-y*y-w*w;if(C>=0){C*=C,i=s[O+1+n[P+1]];var R=this._gradients[i];u=C*C*(R[0]*y+R[1]*w)}return 70*(c+l+u)},o}(qt)},te=function(){function t(t,e,i,r){void 0===r&&(r={}),this._toX=t,this._toY=e,this._passableCallback=i,this._options=Object.assign({topology:8},r),this._dirs=Q[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])}return t.prototype._getNeighbors=function(t,e){for(var i=[],r=0;r<this._dirs.length;r++){var o=this._dirs[r],n=t+o[0],s=e+o[1];this._passableCallback(n,s)&&i.push([n,s])}return i},t}();function ee(t,e){return ee=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},ee(t,e)}function ie(t,e){return ie=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},ie(t,e)}var re={Dijkstra:function(t){var e,i;function r(e,i,r,o){var n;return(n=t.call(this,e,i,r,o)||this)._computed={},n._todo=[],n._add(e,i,null),n}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,ee(e,i);var o=r.prototype;return o.compute=function(t,e,i){var r=t+","+e;if(r in this._computed||this._compute(t,e),r in this._computed)for(var o=this._computed[r];o;)i(o.x,o.y),o=o.prev},o._compute=function(t,e){for(;this._todo.length;){var i=this._todo.shift();if(i.x==t&&i.y==e)return;for(var r=this._getNeighbors(i.x,i.y),o=0;o<r.length;o++){var n=r[o],s=n[0],a=n[1];s+","+a in this._computed||this._add(s,a,i)}}},o._add=function(t,e,i){var r={x:t,y:e,prev:i};this._computed[t+","+e]=r,this._todo.push(r)},r}(te),AStar:function(t){var e,i;function r(e,i,r,o){var n;return void 0===o&&(o={}),(n=t.call(this,e,i,r,o)||this)._todo=[],n._done={},n}i=t,(e=r).prototype=Object.create(i.prototype),e.prototype.constructor=e,ie(e,i);var o=r.prototype;return o.compute=function(t,e,i){for(this._todo=[],this._done={},this._fromX=t,this._fromY=e,this._add(this._toX,this._toY,null);this._todo.length;){var r=this._todo.shift(),o=r.x+","+r.y;if(!(o in this._done)){if(this._done[o]=r,r.x==t&&r.y==e)break;for(var n=this._getNeighbors(r.x,r.y),s=0;s<n.length;s++){var a=n[s],h=a[0],c=a[1];h+","+c in this._done||this._add(h,c,r)}}}var l=this._done[t+","+e];if(l)for(;l;)i(l.x,l.y),l=l.prev},o._add=function(t,e,i){for(var r=this._distance(t,e),o={x:t,y:e,prev:i,g:i?i.g+1:0,h:r},n=o.g+o.h,s=0;s<this._todo.length;s++){var a=this._todo[s],h=a.g+a.h;if(n<h||n==h&&r<a.h)return void this._todo.splice(s,0,o)}this._todo.push(o)},o._distance=function(t,e){switch(this._options.topology){case 4:return Math.abs(t-this._fromX)+Math.abs(e-this._fromY);case 6:var i=Math.abs(t-this._fromX),r=Math.abs(e-this._fromY);return r+Math.max(0,(i-r)/2);case 8:return Math.max(Math.abs(t-this._fromX),Math.abs(e-this._fromY))}},r}(te)},oe=function(){function t(t){this._scheduler=t,this._lock=1}var e=t.prototype;return e.start=function(){return this.unlock()},e.lock=function(){return this._lock++,this},e.unlock=function(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){var t=this._scheduler.next();if(!t)return this.lock();var e=t.act();e&&e.then&&(this.lock(),e.then(this.unlock.bind(this)))}return this},t}(),ne=function(){function t(t,e){void 0===e&&(e={}),this._reflectivityCallback=t,this._options={},e=Object.assign({passes:1,emissionThreshold:100,range:10},e),this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(e)}var e=t.prototype;return e.setOptions=function(t){return Object.assign(this._options,t),t&&t.range&&this.reset(),this},e.setFOV=function(t){return this._fov=t,this._fovCache={},this},e.setLight=function(t,e,i){var r=t+","+e;return i?this._lights[r]="string"==typeof i?m(i):i:delete this._lights[r],this},e.clearLights=function(){this._lights={}},e.reset=function(){return this._reflectivityCache={},this._fovCache={},this},e.compute=function(t){var e={},i={},r={};for(var o in this._lights){var n=this._lights[o];i[o]=[0,0,0],b(i[o],n)}for(var s=0;s<this._options.passes;s++)this._emitLight(i,r,e),s+1!=this._options.passes&&(i=this._computeEmitters(r,e));for(var a in r){var h=a.split(",");t(parseInt(h[0]),parseInt(h[1]),r[a])}return this},e._emitLight=function(t,e,i){for(var r in t){var o=r.split(","),n=parseInt(o[0]),s=parseInt(o[1]);this._emitLightFromCell(n,s,t[r],e),i[r]=1}return this},e._computeEmitters=function(t,e){var i={};for(var r in t)if(!(r in e)){var o=t[r],n=void 0;if(r in this._reflectivityCache)n=this._reflectivityCache[r];else{var s=r.split(","),a=parseInt(s[0]),h=parseInt(s[1]);n=this._reflectivityCallback(a,h),this._reflectivityCache[r]=n}if(0!=n){for(var c=[0,0,0],l=0,u=0;u<3;u++){var _=Math.round(o[u]*n);c[u]=_,l+=_}l>this._options.emissionThreshold&&(i[r]=c)}}return i},e._emitLightFromCell=function(t,e,i,r){var o,n=t+","+e;for(var s in o=n in this._fovCache?this._fovCache[n]:this._updateFOV(t,e)){var a=o[s],h=void 0;s in r?h=r[s]:(h=[0,0,0],r[s]=h);for(var c=0;c<3;c++)h[c]+=Math.round(i[c]*a)}return this},e._updateFOV=function(t,e){var i=t+","+e,r={};this._fovCache[i]=r;var o=this._options.range;return this._fov.compute(t,e,o,function(t,e,i,n){var s=n*(1-i/o);0!=s&&(r[t+","+e]=s)}.bind(this)),r},t}(),se=u,ae=C,he=q;t.Color=ae,t.DEFAULT_HEIGHT=25,t.DEFAULT_WIDTH=80,t.DIRS=Q,t.Display=$,t.Engine=oe,t.EventQueue=ot,t.FOV=yt,t.KEYS={VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95},t.Lighting=ne,t.Map=Gt,t.Noise=$t,t.Path=re,t.RNG=r,t.Scheduler=ut,t.StringGenerator=tt,t.Text=he,t.Util=se,Object.defineProperty(t,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ROT={})}));
